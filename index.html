<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Ventas - Panader√≠a</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Chart.js para gr√°ficos en el reporte -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Secci√≥n de cobro en efectivo tipo pantalla completa FUERA del contenedor principal -->
    <div id="pantallaEfectivo" class="pantalla-efectivo hidden">
        <div class="efectivo-container pantalla-efectivo-container">
            <div class="efectivo-header">
                <h2>üíµ Cobro en Efectivo</h2>
                <div class="efectivo-total">Total a pagar: <span id="pantallaEfectivoTotal">$0.00</span></div>
            </div>
            <h3 style="margin-bottom: 15px; text-align:center;">Selecciona con qu√© paga:</h3>
            <div class="billetes-grid">
                <!-- Los billetes se renderizan din√É¬°micamente por JS -->
            </div>
            <div class="monedas-row">
                <!-- Las monedas se renderizan din√É¬°micamente por JS -->
            </div>
            <div class="monto-recibido-display">
                <label>Monto recibido: <strong>$<span id="pantallaEfectivoRecibido">0.00</span></strong></label>
                <button class="btn-resetear" onclick="pantallaEfectivoReset()">Limpiar</button>
            </div>
            <div class="cambio-modal">
                <h3>Cambio: <span id="pantallaEfectivoCambio">0.00</span></h3>
            </div>
            <button class="btn-cerrar-venta" onclick="pantallaEfectivoConfirmar()">Cerrar Venta</button>
            <button class="btn-cancelar" onclick="pantallaEfectivoCancelar()" style="margin-top:10px;">Cancelar</button>
        </div>
    </div>
    <div class="container" id="mainContainer">
        <header>
            <h1>ü•ñ Registro de Ventas - Panader√≠a</h1>
            <p class="fecha" id="fecha"></p>
        </header>

        <div class="main-content">
            <!-- Productos -->
            <section class="productos-section">
                <div id="categoriasTabs" class="categorias-tabs"></div>
                <div class="productos-grid" id="productosGrid"></div>
            </section>

            <!-- Carrito y Pago -->
            <section class="carrito-section">
                <div class="carrito">
                    <h2>Carrito de Compra</h2>
                    <div id="carritoItems" class="carrito-items"></div>
                    <div class="carrito-total">
                        <h3>Total: $<span id="totalCarrito">0.00</span></h3>
                    </div>
                    <button class="btn-limpiar" onclick="limpiarCarrito()">Limpiar Carrito</button>
                </div>

                <div class="pago">
                    <h2>M√©todo de Pago</h2>
                    <div class="metodo-pago">
                        <button class="btn-pago" onclick="seleccionarMetodo('tarjeta')">üí≥ Tarjeta</button>
                        <button class="btn-pago" onclick="seleccionarMetodo('efectivo')">üíµ Efectivo</button>
                    </div>
                </div>

                <div class="operaciones">
                    <h2>üí¥ Operaciones</h2>
                    <button class="btn-admin" onclick="abrirModalVentaManual()">üí∏ Venta Manual</button>
                    <button class="btn-admin" onclick="abrirModalRetiro()">üí∂ Retirar Efectivo</button>
                    <button class="btn-admin" onclick="abrirModalIngreso()">üíµ Ingresar Efectivo</button>
                </div>

                <div class="admin">
                    <h2>‚öôÔ∏è Administraci√≥n</h2>
                    <button class="btn-admin" onclick="abrirModalProductos()">Ver Productos</button>
                    <button class="btn-admin" onclick="abrirModalReporte()">Ver Reporte</button>
                    <button class="btn-admin" onclick="abrirModalConfigOperaciones()">‚ö° Configurar Operaciones</button>
                    <button class="btn-admin" id="btnReordenar" onclick="toggleModoReordenar()">üîÄ Reordenar Productos</button>
                </div>
            </section>
        </div>
    </div>

    <!-- Modal Reporte -->

    <!-- Canvas oculto para generar gr√°ficos del reporte -->
    <div style="position: absolute; left: -9999px; top: -9999px; width: 800px; height: 400px;">
        <canvas id="reporteChart" width="800" height="400"></canvas>
    </div>
    <div id="modalReporte" class="modal hidden">
        <div class="modal-content modal-reporte-mejorado">
            <div class="modal-header">
                <h2>üìä An√°lisis de Ventas</h2>
                <span class="modal-close" onclick="cerrarModalReporte()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Navegaci√≥n de fecha -->
                <div class="reporte-header">
                    <div class="navegacion-fecha">
                        <button class="btn-fecha-nav" onclick="cambiarDiaReporte(-1)">‚óÄ</button>
                        <h3 id="reporteFechaModal"></h3>
                        <button class="btn-fecha-nav" onclick="cambiarDiaReporte(1)">‚ñ∂</button>
                    </div>
                </div>

                <!-- Pesta√±as de navegaci√≥n -->
                <div class="reporte-tabs">
                    <button class="reporte-tab active" onclick="cambiarTabReporte('resumen')">üìã Resumen</button>
                    <button class="reporte-tab" onclick="cambiarTabReporte('graficos')">üìà Gr√°ficos</button>
                    <button class="reporte-tab" onclick="cambiarTabReporte('comparativa')">‚öñÔ∏è Comparativa</button>
                    <button class="reporte-tab" onclick="cambiarTabReporte('detalles')">üìù Detalles</button>
                </div>


                <!-- TAB: Resumen -->
                <div id="tabResumen" class="reporte-tab-content active">
                    <!-- Cards de m√©tricas principales -->
                    <div class="metricas-grid">
                        <div class="metrica-card">
                            <div class="metrica-icon">üí∞</div>
                            <div class="metrica-info">
                                <span class="metrica-label">Total del D√≠a</span>
                                <span class="metrica-valor">$<span id="metricaTotal">0.00</span></span>
                                <span class="metrica-cambio" id="metricaTotalCambio"></span>
                            </div>
                        </div>
                        <div class="metrica-card">
                            <div class="metrica-icon">üßæ</div>
                            <div class="metrica-info">
                                <span class="metrica-label">Transacciones</span>
                                <span class="metrica-valor"><span id="metricaTransacciones">0</span></span>
                                <span class="metrica-cambio" id="metricaTransaccionesCambio"></span>
                            </div>
                        </div>
                        <div class="metrica-card">
                            <div class="metrica-icon">üìä</div>
                            <div class="metrica-info">
                                <span class="metrica-label">Ticket Promedio</span>
                                <span class="metrica-valor">$<span id="metricaTicketPromedio">0.00</span></span>
                                <span class="metrica-cambio" id="metricaTicketPromedioCambio"></span>
                            </div>
                        </div>
                        <div class="metrica-card">
                            <div class="metrica-icon">‚≠ê</div>
                            <div class="metrica-info">
                                <span class="metrica-label">M√°s Vendido</span>
                                <span class="metrica-valor-small" id="metricaMasVendido">-</span>
                            </div>
                        </div>
                    </div>

               
                    <!-- Resumen de ventas -->
                    <div class="reporte-seccion">
                        <h4>üí≥ M√©todos de Pago</h4>
                        <div class="metodos-pago-visual">
                            <div class="metodo-pago-item">
                                <div class="metodo-header">
                                    <span>üí≥ Tarjeta</span>
                                    <strong>$<span id="reporteTarjeta">0.00</span></strong>
                                </div>
                                <div class="metodo-barra">
                                    <div class="metodo-barra-fill tarjeta" id="barraTarjeta" style="width: 0%"></div>
                                </div>
                                <span class="metodo-porcentaje" id="porcentajeTarjeta">0%</span>
                            </div>
                            <div class="metodo-pago-item">
                                <div class="metodo-header">
                                    <span>üíµ Efectivo</span>
                                    <strong>$<span id="reporteEfectivo">0.00</span></strong>
                                </div>
                                <div class="metodo-barra">
                                    <div class="metodo-barra-fill efectivo" id="barraEfectivo" style="width: 0%"></div>
                                </div>
                                <span class="metodo-porcentaje" id="porcentajeEfectivo">0%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Top productos -->
                    <div class="reporte-seccion">
                        <h4>üèÜ Top 5 Productos M√°s Vendidos</h4>
                        <div id="topProductos" class="top-productos"></div>
                    </div>

                    <!-- Retiros -->
                    <div class="reporte-seccion">
                        <h4>üí∏ Retiros de Efectivo</h4>
                        <div id="reporteRetiros" class="reporte-retiros"></div>
                    </div>
                </div>

                <!-- TAB: Gr√°ficos -->
                <div id="tabGraficos" class="reporte-tab-content">
                    <div class="reporte-seccion">
                        <h4>üìä Ventas por Hora</h4>
                        <canvas id="chartVentasPorHora"></canvas>
                    </div>
                    
                    <div class="reporte-seccion">
                        <h4>üìà Tendencia Semanal</h4>
                        <canvas id="chartTendenciaSemanal"></canvas>
                    </div>

                    <div class="reporte-seccion">
                        <h4>ü•ß Distribuci√≥n de Ventas</h4>
                        <canvas id="chartDistribucion"></canvas>
                    </div>
                </div>

                <!-- TAB: Comparativa -->
                <div id="tabComparativa" class="reporte-tab-content">
                    <div class="comparativa-selector">
                        <label>Comparar con:</label>
                        <select id="comparativaSelector" onchange="actualizarComparativa()">
                            <option value="ayer">D√≠a anterior</option>
                            <option value="semana-pasada">Mismo d√≠a semana pasada</option>
                            <option value="promedio-semana">Promedio de la semana</option>
                        </select>
                    </div>

                    <div class="comparativa-grid" id="comparativaGrid">
                        <!-- Se llena din√°micamente -->
                    </div>

                    <div class="reporte-seccion">
                        <h4>üìä Comparaci√≥n Visual</h4>
                        <canvas id="chartComparativa"></canvas>
                    </div>
                </div>

                <!-- TAB: Detalles -->
                <div id="tabDetalles" class="reporte-tab-content">
                    <div class="reporte-seccion">
                        <h4>üì¶ Todos los Productos Vendidos</h4>
                        <div id="reporteProductos" class="reporte-productos-detallado"></div>
                    </div>

                    <div class="reporte-seccion">
                        <h4>üïê Historial de Transacciones</h4>
                        <div id="historialTransacciones" class="historial-transacciones"></div>
                    </div>
                </div>

                <!-- Alertas -->
                <div id="alertasReporte" class="alertas-reporte"></div>
                
                <button class="btn-descargar-modal" onclick="descargarReporte()">üì• Descargar Reporte Completo</button>
            </div>
        </div>
    </div>

    <!-- Modal Productos -->
    <div id="modalProductos" class="modal hidden">
        <div class="modal-content modal-productos">
            <div class="modal-header">
                <h2>üì¶ Base de Datos de Productos</h2>
                <span class="modal-close" onclick="cerrarModalProductos()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn-agregar-producto" onclick="mostrarFormularioProducto()">+ Agregar Producto</button>
                    <button class="btn-agregar-producto" onclick="toggleGestionCategorias()">‚öôÔ∏è Gestionar Categor√≠as</button>
                    <button class="btn-agregar-producto" onclick="document.getElementById('csvInput').click()">üìÑ Importar CSV</button>
                    <input type="file" id="csvInput" accept=".csv" style="display: none;" onchange="importarCSV(event)">
                </div>
                
                <!-- Gesti√≥n de Categor√≠as -->
                <div id="gestionCategorias" class="gestion-categorias hidden">
                    <h3 style="margin-bottom: 15px;">Gesti√≥n de Categor√≠as</h3>
                    
                    <div id="formularioCategoria" class="formulario-producto hidden">
                        <h4 id="tituloCategoriaForm">Nueva Categor√≠a</h4>
                        <input type="hidden" id="categoriaKeyEdit">
                        <div class="form-group">
                            <label>Nombre:</label>
                            <input type="text" id="categoriaNombre" placeholder="ej: Postres">
                        </div>
                        <div class="form-group">
                            <label>Color:</label>
                            <input type="color" id="categoriaColor" value="#9b59b6">
                        </div>
                        <div class="form-buttons">
                            <button class="btn-cancelar" onclick="cancelarFormularioCategoria()">Cancelar</button>
                            <button class="btn-guardar" onclick="guardarCategoria()">Guardar</button>
                        </div>
                    </div>
                    
                    <button class="btn-agregar-producto" onclick="mostrarFormularioCategoria()" style="margin-bottom: 15px;">+ Nueva Categor√≠a</button>
                    
                    <div class="categorias-lista" id="categoriasLista"></div>
                    <hr style="margin: 20px 0; border: 1px solid #eee;">
                </div>
                
                <div id="formularioProducto" class="formulario-producto hidden">
                    <h4 id="tituloFormulario">Nuevo Producto</h4>
                    <input type="hidden" id="productoIdEdit">
                    <div class="form-group">
                        <label>Nombre:</label>
                        <input type="text" id="productoNombre" placeholder="Nombre del producto">
                    </div>
                    <div class="form-group">
                        <label>Precio:</label>
                        <input type="tel" id="productoPrecio" placeholder="0.00" pattern="[0-9.]*">
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a:</label>
                        <select id="productoCategoria">
                            <option value="bebidas">Bebidas</option>
                            <option value="panDulce">Pan Dulce</option>
                            <option value="panBlanco">Pan Blanco</option>
                            <option value="hogazas">Hogazas / Baguette</option>
                        </select>
                    </div>
                    <div class="form-buttons">
                        <button class="btn-cancelar" onclick="cancelarFormulario()">Cancelar</button>
                        <button class="btn-guardar" onclick="guardarProducto()">Guardar</button>
                    </div>
                </div>
                
                <div class="productos-lista" id="productosLista"></div>
            </div>
        </div>
    </div>


    <!-- Modal Cambio -->
    <div id="modalCambio" class="modal hidden">
        <div class="modal-content modal-cambio">
            <div class="modal-body">
                <div class="cambio-info">
                    <h2 style="text-align: center; color: #28a745; margin-bottom: 20px;">‚úÖ Venta Completada</h2>
                    <div class="cambio-item">
                        <span>Total:</span>
                        <strong>$<span id="cambioTotal">0.00</span></strong>
                    </div>
                    <div class="cambio-item">
                        <span>Recibido:</span>
                        <strong>$<span id="cambioRecibido">0.00</span></strong>
                    </div>
                    <div class="cambio-item cambio-final">
                        <span>Cambio:</span>
                        <strong class="cambio-amount">$<span id="cambioMonto">0.00</span></strong>
                    </div>
                </div>
                <p style="text-align: center; color: #666; margin-top: 15px; font-size: 14px;">
                    Cerrando autom√°ticamente...
                </p>
            </div>
        </div>
    </div>

    <!-- Modal Venta Manual -->
    <div id="modalVentaManual" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>√∞≈∏‚Äô¬∞ Venta Manual</h2>
                <span class="modal-close" onclick="cerrarModalVentaManual()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Monto de la venta:</label>
                    <input type="tel" id="montoVentaManual" placeholder="0.00" pattern="[0-9.]*" autofocus>
                </div>
                <div class="form-group">
                    <label>M√©todo de pago:</label>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn-pago" onclick="seleccionarMetodoVentaManual('tarjeta')" style="flex: 1;">√∞≈∏‚Äô¬≥ Tarjeta</button>
                        <button class="btn-pago" onclick="seleccionarMetodoVentaManual('efectivo')" style="flex: 1;">√∞≈∏‚Äô¬µ Efectivo</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n (opcional):</label>
                    <textarea id="descripcionVentaManual" placeholder="Ej: Producto especial, pedido personalizado, etc." rows="2"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Retiro -->
    <div id="modalRetiro" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí∂ Retirar Efectivo</h2>
                <span class="modal-close" onclick="cerrarModalRetiro()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Operaciones R√°pidas:</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                        <!-- Los botones se cargan din√É¬°micamente desde JavaScript -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Monto a retirar:</label>
                    <input type="tel" id="montoRetiro" placeholder="0.00" pattern="[0-9.]*">
                </div>
                <div class="form-group">
                    <label>Justificaci√≥n:</label>
                    <textarea id="justificacionRetiro" placeholder="Ej: Compra de insumos, pago a proveedor, etc." rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-cancelar" onclick="cerrarModalRetiro()" style="flex: 1;">Cancelar</button>
                    <button class="btn-guardar" onclick="confirmarRetiro()" style="flex: 1;">Confirmar Retiro</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Configuraci√É¬≥n de Operaciones -->
    <div id="modalConfigOperaciones" class="modal hidden">
        <div class="modal-content modal-grande">
            <div class="modal-header">
                <h2>‚ö° Configurar Operaciones R√°pidas</h2>
                <span class="modal-close" onclick="cerrarModalConfigOperaciones()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- Retiros -->
                    <div>
                        <h3 style="margin-bottom: 15px; color: #d9534f;">üí∂ Operaciones de Retiro</h3>
                        <button class="btn-admin" onclick="mostrarFormularioOperacion('retiro')" style="width: 100%; margin-bottom: 15px;">+ Agregar Retiro</button>
                        <div id="listaOperacionesRetiro" class="lista-operaciones"></div>
                    </div>
                    
                    <!-- Ingresos -->
                    <div>
                        <h3 style="margin-bottom: 15px; color: #28a745;">üíµ Operaciones de Ingreso</h3>
                        <button class="btn-admin" onclick="mostrarFormularioOperacion('ingreso')" style="width: 100%; margin-bottom: 15px;">+ Agregar Ingreso</button>
                        <div id="listaOperacionesIngreso" class="lista-operaciones"></div>
                    </div>
                </div>
                
                <!-- Formulario de operaci√É¬≥n -->
                <div id="formularioOperacion" class="hidden" style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #e5e7eb;">
                    <h3 id="tituloOperacionForm">Nueva Operaci√≥n</h3>
                    <input type="hidden" id="operacionIdEdit">
                    <input type="hidden" id="operacionTipoEdit">
                    
                    <div class="form-group">
                        <label>Emoji:</label>
                        <input type="text" id="operacionEmoji" placeholder="üóëÔ∏è" maxlength="2" style="font-size: 24px; text-align: center;">
                    </div>
                    
                    <div class="form-group">
                        <label>Nombre:</label>
                        <input type="text" id="operacionNombre" placeholder="Ej: Basura, Gas, Pr√©stamo">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn-cancelar" onclick="cancelarFormularioOperacion()" style="flex: 1;">Cancelar</button>
                        <button class="btn-guardar" onclick="guardarOperacion()" style="flex: 1;">Guardar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ingreso -->
    <div id="modalIngreso" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üíµ Ingresar Efectivo</h2>
                <span class="modal-close" onclick="cerrarModalIngreso()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Operaciones R√°pidas:</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                        <!-- Los botones se cargan din√É¬°micamente desde JavaScript -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Monto a ingresar:</label>
                    <input type="tel" id="montoIngreso" placeholder="0.00" pattern="[0-9.]*">
                </div>
                <div class="form-group">
                    <label>Concepto:</label>
                    <textarea id="conceptoIngreso" placeholder="Ej: Fondo inicial de caja, pr√©stamo personal, etc." rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-cancelar" onclick="cerrarModalIngreso()" style="flex: 1;">Cancelar</button>
                    <button class="btn-guardar" onclick="confirmarIngreso()" style="flex: 1;">Confirmar Ingreso</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="app.js?v=2"></script>
    <script>
    // --- Orden y renderizado din√É¬°mico de billetes y monedas con drag & drop ---
    const denominacionesBilletes = [500, 200, 100, 50, 20];
    const denominacionesMonedas = [10, 5, 2, 1];

    function renderizarBilletesYMonedas() {
        const billetesGrid = document.querySelector('.billetes-grid');
        const monedasRow = document.querySelector('.monedas-row');
        billetesGrid.innerHTML = '';
        monedasRow.innerHTML = '';
        denominacionesBilletes.forEach(valor => {
            const div = document.createElement('div');
            div.className = 'billete';
            div.draggable = true;
            div.dataset.valor = valor;
            div.innerHTML = `<img src="DINERO/${valor} pesos.png" alt="$${valor}" class="img-billete">`;
            div.onclick = () => pantallaEfectivoAgregar(valor);
            agregarDragDrop(div, denominacionesBilletes, renderizarBilletesYMonedas);
            billetesGrid.appendChild(div);
        });
        denominacionesMonedas.forEach(valor => {
            const div = document.createElement('div');
            div.className = 'moneda';
            div.draggable = true;
            div.dataset.valor = valor;
            div.innerHTML = `<img src="DINERO/${valor} pesos.png" alt="$${valor}" class="img-moneda">`;
            div.onclick = () => pantallaEfectivoAgregar(valor);
            agregarDragDrop(div, denominacionesMonedas, renderizarBilletesYMonedas);
            monedasRow.appendChild(div);
        });
    }

    function agregarDragDrop(element, array, rerender) {
        element.addEventListener('dragstart', e => {
            e.dataTransfer.setData('valor', element.dataset.valor);
            element.classList.add('dragging');
        });
        element.addEventListener('dragend', e => {
            element.classList.remove('dragging');
        });
        element.addEventListener('dragover', e => {
            e.preventDefault();
        });
        element.addEventListener('drop', e => {
            e.preventDefault();
            const valorArrastrado = parseInt(e.dataTransfer.getData('valor'));
            const valorDestino = parseInt(element.dataset.valor);
            const idxFrom = array.indexOf(valorArrastrado);
            const idxTo = array.indexOf(valorDestino);
            if (idxFrom !== -1 && idxTo !== -1 && idxFrom !== idxTo) {
                array.splice(idxFrom, 1);
                array.splice(idxTo, 0, valorArrastrado);
                rerender();
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderizarBilletesYMonedas();
    });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            cargarDatosLocalStorage();
        });
    </script>
</body>
</html>
